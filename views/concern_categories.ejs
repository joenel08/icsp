<!-- users.ejs -->
<% if (!user) { %>
    <script>
        alert("Please log in first.");
        window.location.href = "/";
    </script>
    <% } %>
        <!DOCTYPE html>
        <html lang="en">

        <head>
            <title>ICSP - Categories Page</title>
            <%- include('partials/headerlink') %>

        </head>

        <body class="app">
            <header class="app-header fixed-top">
                <%- include('partials/navbar') %>
                    <%- include('partials/sidebar') %>
            </header><!--//app-header-->
            <div class="app-wrapper">
                <div class="app-content pt-3 p-md-3 p-lg-4">
                    <div class="container-xl">
                        <div class="app-card">
                            <div class="app-card-header pt-3 p-md-3 p-lg-4">
                                <div class="row align-items-center justify-content-between">
                                    <div class="col-auto">
                                        <h1 class="app-page-title">Categories List</h1>
                                    </div>
                                    <div class="col-auto">
                                        <button data-bs-toggle="modal" data-bs-target="#insertModal"
                                            class="btn btn-primary text-right" href="#">
                                            <!-- <svg width="1em"
                    height="1em" viewBox="0 0 16 16" class="bi bi-upload me-2"
                    fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd"
                        d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z">
                    </path>
                    <path fill-rule="evenodd"
                        d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z">
                    </path>
                </svg> -->
                                            Insert New Category</button>
                                    </div>
                                </div>
                            </div>
                            <div class="app-card-body  p-3 border-bottom-0">





                                <table id="list" class="table table-striped table-bordered">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Category</th>
                                            <th>Sub Types</th>
                                            <th>Safety Risk</th>
                                            <th>Impact Area</th>
                                            <th>Report Frequency</th>
                                            <th>Priority Level</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% categories.forEach(function(category) { %>
                                            <tr>
                                                <td>
                                                    <%= category._id %>
                                                </td>
                                                <td>
                                                    <%= category.category_name %>
                                                </td>
                                                <td>
                                                    <% if (category.sub_types && category.sub_types.length> 0) { %>
                                                        <ul>
                                                            <% category.sub_types.forEach(function(subType) { %>
                                                                <li>
                                                                    <%= subType %>
                                                                </li>
                                                                <% }); %>
                                                        </ul>
                                                        <% } else { %>
                                                            <span>No sub-types available</span>
                                                            <% } %>
                                                </td>
                                                <td>
                                                    <%= category.safety_risk===1 ? 'Minimal Risk' :
                                                        category.safety_risk===2 ? 'Low Risk' : category.safety_risk===3
                                                        ? 'Moderate Risk' : category.safety_risk===4 ? 'High Risk' :
                                                        category.safety_risk===5 ? 'Very High Risk' : 'Unknown' %>
                                                </td>
                                                <td>
                                                    <%= category.impact_area===1 ? 'Minimal Impact' :
                                                        category.impact_area===2 ? 'Low Impact' :
                                                        category.impact_area===3 ? 'Moderate Impact' :
                                                        category.impact_area===4 ? 'High Impact' :
                                                        category.impact_area===5 ? 'Very High Impact' : 'Unknown' %>
                                                </td>
                                                <td>
                                                    <%= category.report_frequency===1 ? 'Rarely Reported' :
                                                        category.report_frequency===2 ? 'Sometimes Reported' :
                                                        category.report_frequency===3 ? 'Occasionally Reported' :
                                                        category.report_frequency===4 ? 'Often Reported' :
                                                        category.report_frequency===5 ? 'Frequently Reported'
                                                        : 'Unknown' %>
                                                </td>

                                                <td>
                                                    <span class="badge 
                                                        <%= category.priority_level === 'high' ? 'bg-danger' : 
                                                            category.priority_level === 'mid' ? 'bg-warning' : 
                                                            'bg-info' %>">
                                                        <%= category.priority_level %>
                                                    </span>
                                                </td>
                                                <td>
                                                    <button
                                                        class="btn btn-primary btn-sm update-btn update-category-btn"
                                                        data-category-id="<%= category._id %>"
                                                        data-category-name="<%= category.category_name %>"
                                                        data-priority-level="<%= category.priority_level %>"
                                                        data-bs-toggle="modal" data-bs-target="#updateCategoryModal">
                                                        Update
                                                    </button>

                                                    <!-- Delete Button -->
                                                    <button class="btn btn-danger btn-sm delete-category-btn"
                                                        data-id="<%= category._id %>">
                                                        Delete
                                                    </button>

                                                </td>
                                            </tr>
                                            <% }) %>
                                    </tbody>
                                </table>

                            </div>
                        </div>
                    </div><!--//container-xl-->
                </div><!--//app-content-->
                <!-- Footer -->
                <%- include('partials/footer') %>
            </div><!--//app-wrapper-->
            <!-- Insert Modal -->
            <div class="modal fade" id="insertModal" tabindex="-1" aria-labelledby="insertModalLabel"
                aria-hidden="true">
                <div class="modal-dialog">
                    <form id="insertCategoryForm">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="insertModalLabel">Insert New Category</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <input type="hidden" id="categoryId" name="categoryId">

                                <div class="mb-3">
                                    <label for="insertCategoryName" class="form-label">Category Name</label>
                                    <input type="text" class="form-control" id="insertCategoryName" name="categoryName"
                                        required>
                                </div>
                                <div class="form-group">
                                    <label for="subtypes" class="form-label">Subtypes</label>
                                    <!-- Add Subtype Button -->
                                    <button type="button" class="ml-2 btn btn-success btn-sm addSubtypeBtn"
                                        id="addSubtypeBtn"><i class="fa fa-plus"></i> Add
                                    </button>

                                    <!-- Subtype Input Fields (Initially empty or with one input field) -->
                                    <div id="subtypesContainer">
                                        <div class="subtype-row d-flex">
                                            <input type="text" class="form-control" name="subtypes[]">

                                        </div>
                                    </div>

                                </div>
                                <hr>
                                <!-- Safety Risk Radio Buttons -->
                                <div class="mb-3">
                                    <label class="form-label">Safety Risk (SR)</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="safetyRisk" id="sr1"
                                            value="1" required>
                                        <label class="form-check-label" for="sr1">1 - Minimal Risk</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="safetyRisk" id="sr2"
                                            value="2">
                                        <label class="form-check-label" for="sr2">2 - Low Risk</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="safetyRisk" id="sr3"
                                            value="3">
                                        <label class="form-check-label" for="sr3">3 - Moderate Risk</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="safetyRisk" id="sr4"
                                            value="4">
                                        <label class="form-check-label" for="sr4">4 - High Risk</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="safetyRisk" id="sr5"
                                            value="5">
                                        <label class="form-check-label" for="sr5">5 - Very High Risk</label>
                                    </div>
                                </div>

                                <!-- Impact Area Radio Buttons -->
                                <div class="mb-3">
                                    <label class="form-label">Impact Area (IA)</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="impactArea" id="ia1"
                                            value="1" required>
                                        <label class="form-check-label" for="ia1">1 - Minimal Impact</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="impactArea" id="ia2"
                                            value="2" required>
                                        <label class="form-check-label" for="ia2">2 - Low Impact</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="impactArea" id="ia3"
                                            value="3" required>
                                        <label class="form-check-label" for="ia3">3 - Moderate Impact</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="impactArea" id="ia4"
                                            value="4" required>
                                        <label class="form-check-label" for="ia4">4 - High Impact</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="impactArea" id="ia5"
                                            value="5" required>
                                        <label class="form-check-label" for="ia5">5 - Very High Impact</label>
                                    </div>






                                </div>

                                <!-- Report Frequency Radio Buttons -->
                                <div class="mb-3">
                                    <label class="form-label">Report Frequency (RF)</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="reportFrequency" id="rf1"
                                            value="1">
                                        <label class="form-check-label" for="rf1">1 - Rarely Reported</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="reportFrequency" id="rf2"
                                            value="2">
                                        <label class="form-check-label" for="rf2">2 - Sometimes Reported</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="reportFrequency" id="rf3"
                                            value="3">
                                        <label class="form-check-label" for="rf3">3 - Occasionally Reported</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="reportFrequency" id="rf4"
                                            value="4">
                                        <label class="form-check-label" for="rf4">4 - Often Reported</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="reportFrequency" id="rf5"
                                            value="5">
                                        <label class="form-check-label" for="rf5">5 - Frequently Reported</label>
                                    </div>





                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="submit" class="btn btn-success">Save Category</button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <!-- Update Category Modal -->
            <div class="modal fade" id="updateCategoryModal" tabindex="-1" aria-labelledby="updateCategoryModalLabel"
                aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="updateCategoryModalLabel">Update Category</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="updateCategoryForm">
                                <div class="mb-3">
                                    <label for="updateCategoryName" class="form-label">Category Name</label>
                                    <input type="text" class="form-control" id="updateCategoryName" name="categoryName"
                                        required>
                                    <input type="hidden" class="form-control" id="categoryID" name="category_id">
                                </div>
                                <div class="form-group">
                                    <label for="subtypes" class="form-label">Subtypes</label>

                                    <!-- Add Subtype Button -->
                                    <button type="button" class="ml-2 btn btn-success btn-sm addSubtypeBtn1"
                                        id="addSubtypeBtn_update"><i class="fa fa-plus"></i> Add
                                    </button>
                                    <div id="updateSubtypesContainer"></div>
                                </div>
                                <!-- Subtype Input Fields (Initially empty or with one input field) -->


                                <hr>

                                <!-- Safety Risk Radio Buttons -->
                                <div class="mb-3">
                                    <label class="form-label">Safety Risk (SR)</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="safetyRisk" id="sr1"
                                            value="1">
                                        <label class="form-check-label" for="sr1">1 - Minimal Risk</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="safetyRisk" id="sr2"
                                            value="2">
                                        <label class="form-check-label" for="sr2">2 - Low Risk</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="safetyRisk" id="sr3"
                                            value="3">
                                        <label class="form-check-label" for="sr3">3 - Moderate Risk</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="safetyRisk" id="sr4"
                                            value="4">
                                        <label class="form-check-label" for="sr4">4 - High Risk</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="safetyRisk" id="sr5"
                                            value="5">
                                        <label class="form-check-label" for="sr5">5 - Very High Risk</label>
                                    </div>
                                </div>

                                <!-- Impact Area Radio Buttons -->
                                <div class="mb-3">
                                    <label class="form-label">Impact Area (IA)</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="impactArea" id="ia1"
                                            value="1">
                                        <label class="form-check-label" for="ia1">1 - Minimal Impact</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="impactArea" id="ia2"
                                            value="2">
                                        <label class="form-check-label" for="ia2">2 - Low Impact</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="impactArea" id="ia3"
                                            value="3">
                                        <label class="form-check-label" for="ia3">3 - Moderate Impact</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="impactArea" id="ia4"
                                            value="4">
                                        <label class="form-check-label" for="ia4">4 - High Impact</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="impactArea" id="ia5"
                                            value="5">
                                        <label class="form-check-label" for="ia5">5 - Very High Impact</label>
                                    </div>
                                </div>

                                <!-- Report Frequency Radio Buttons -->
                                <div class="mb-3">
                                    <label class="form-label">Report Frequency (RF)</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="reportFrequency" id="rf1"
                                            value="1">
                                        <label class="form-check-label" for="rf1">1 - Rarely Reported</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="reportFrequency" id="rf2"
                                            value="2">
                                        <label class="form-check-label" for="rf2">2 - Sometimes Reported</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="reportFrequency" id="rf3"
                                            value="3">
                                        <label class="form-check-label" for="rf3">3 - Occasionally Reported</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="reportFrequency" id="rf4"
                                            value="4">
                                        <label class="form-check-label" for="rf4">4 - Often Reported</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="reportFrequency" id="rf5"
                                            value="5">
                                        <label class="form-check-label" for="rf5">5 - Frequently Reported</label>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-success" form="updateCategoryForm"
                                id="updateCategoryBtn">Update
                                Category</button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>





            <%- include('partials/footerLink') %>

                <script>
                    $(document).ready(function () {
                        $('#list').DataTable();
                        // Add Subtype Button




                        $('.addSubtypeBtn1').click(function () {
                            var newSubtype = $('<div class="subtype-row1 mt-2">')
                                .append('<input type="text" class="form-control" name="subtypes1[]">')
                                .append('<button type="button" class="mt-2 btn btn-danger btn-sm remove-subtype1"><i class="fa fa-trash"></i></button>');
                            $('#updateSubtypesContainer').append(newSubtype);
                            newSubtype.find('.remove-subtype1').show(); // Show the remove button for new subtype
                        });

                        // Remove Subtype Button
                        $(document).on('click', '.remove-subtype1', function () {
                            $(this).closest('.subtype-row1').remove();
                        });

                        $('.addSubtypeBtn').click(function () {
                            var newSubtype = $('<div class="subtype-row mt-2">')
                                .append('<input type="text" class="form-control" name="subtypes[]">')
                                .append('<button type="button" class="mt-2 btn btn-danger btn-sm remove-subtype"><i class="fa fa-trash"></i></button>');
                            $('#subtypesContainer').append(newSubtype);
                            newSubtype.find('.remove-subtype').show(); // Show the remove button for new subtype
                        });

                        // Remove Subtype Button
                        $(document).on('click', '.remove-subtype', function () {
                            $(this).closest('.subtype-row').remove();
                        });

                        $(document).on('click', '.update-category-btn', function () {
                            const categoryId = $(this).data('category-id');

                            // Fetch the category details from the server
                            $.ajax({
                                url: `/get-category/${categoryId}`,
                                type: 'GET',
                                success: function (category) {
                                    $('#updateCategoryName').val(category.category_name);
                                    $('#categoryID').val(category._id);

                                    // Set radio button values based on the current category data
                                    $(`input[name="safetyRisk"][value="${category.safety_risk}"]`).prop('checked', true);
                                    $(`input[name="impactArea"][value="${category.impact_area}"]`).prop('checked', true);
                                    $(`input[name="reportFrequency"][value="${category.report_frequency}"]`).prop('checked', true);

                                    // Populate the subtypes
                                    $('#updateSubtypesContainer').empty(); // Clear the previous subtypes
                                    category.sub_types.forEach(function (sub_type) {
                                        var subtypeRow = $('<div class="subtype-row mt-2">')
                                            .append(`<input type="text" class="form-control" name="subtypes[]" value="${sub_type}">`)
                                            .append('<button type="button" class="mt-2 btn btn-danger btn-sm remove-subtype"><i class="fa fa-trash"></i></button>');
                                        $('#updateSubtypesContainer').append(subtypeRow);
                                    });
                                }
                            });
                        });


                        let selectedCategoryId = null;
                        // Handle delete button click
                        $('.delete-btn').on('click', function () {
                            selectedCategoryId = $(this).data('category-id');
                        });

                        $('.delete-category-btn').on('click', function () {
                            const categoryId = $(this).data('id'); // Get category ID from data attribute

                            Swal.fire({
                                title: 'Are you sure?',
                                text: 'Do you want to delete this category?',
                                icon: 'warning',
                                showCancelButton: true,
                                confirmButtonText: 'Yes, delete it!',
                                cancelButtonText: 'No, keep it'
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    $.ajax({
                                        url: `/delete-category/${categoryId}`,
                                        type: 'DELETE',
                                        success: function (response) {
                                            Swal.fire({
                                                icon: 'success',
                                                title: 'Category Deleted',
                                                text: 'The category has been deleted successfully.',
                                                confirmButtonText: 'OK'
                                            }).then(() => {
                                                location.reload(); // or remove the row from the table dynamically
                                            });
                                        },
                                        error: function () {
                                            Swal.fire({
                                                icon: 'error',
                                                title: 'Error',
                                                text: 'An error occurred during deletion.',
                                                confirmButtonText: 'Close'
                                            });
                                        }
                                    });
                                }
                            });
                        });



                        $('#updateCategoryForm').submit(function (e) {
                            e.preventDefault(); // Prevent default form submission

                            // Get the values from the form
                            var categoryName = $('#updateCategoryName').val();
                            var catID = $('#categoryID').val();
                            var subtypes1 = [];

                            // Get the subtypes
                            $('#updateSubtypesContainer input[name="subtypes1[]"]').each(function () {
                                var subtypeVal = $(this).val().trim();
                                if (subtypeVal !== '') {  // Check if subtype is not empty
                                    subtypes1.push(subtypeVal);
                                }
                            });

                            // Check if there are any subtypes
                            if (subtypes1.length === 0) {
                                Swal.fire({
                                    icon: 'warning',
                                    title: 'No Subtypes',
                                    text: 'Please add at least one subtype before updating.',
                                    confirmButtonText: 'OK'
                                });
                                return; // Stop the form from submitting if no subtypes
                            }
                            var safetyRisk = $('input[name="safetyRisk"]:checked').val();
                            var impactArea = $('input[name="impactArea"]:checked').val();
                            var reportFrequency = $('input[name="reportFrequency"]:checked').val();

                            // Create the data object
                            var data = {
                                category_name: categoryName,     // <-- match backend expected name
                                sub_types: subtypes1.join(','),   // <-- backend expects a string to split, not an array
                                safetyRisk: safetyRisk,
                                impactArea: impactArea,
                                reportFrequency: reportFrequency
                            };

                            // Send the data to the server to update the category
                            $.ajax({
                                url: '/update-category/' + catID,
                                type: 'POST',
                                data: data,
                                success: function (response) {

                                    $('#updateCategoryModal').modal('hide');

                                    Swal.fire({
                                        icon: 'success',
                                        title: 'Category Updated',
                                        text: 'The category has been updated successfully.',
                                        confirmButtonText: 'OK'
                                    }).then(() => {
                                        location.reload(); // or update the row dynamically
                                    });
                                },
                                error: function (err) {
                                    alert('Error updating category');
                                }
                            });
                        });
                    });

                    $(document).ready(function () {
                        // Insert form submission
                        $('#insertCategoryForm').on('submit', function (e) {
                            e.preventDefault();

                            const categoryName = $('#insertCategoryName').val();
                            const priorityLevel = $('#insertPriorityLevel').val();
                            const formData = new FormData(this);

                            const subtypes = formData.getAll('subtypes[]').filter(function (subtype) {
                                return subtype.trim() !== '';  // Filter out empty values
                            });


                            const safetyRisk = $('input[name="safetyRisk"]:checked').val(); // Get selected safety risk
                            const impactArea = $('input[name="impactArea"]:checked').val(); // Get selected impact area
                            const reportFrequency = $('input[name="reportFrequency"]:checked').val();



                            // Check if there are any valid subtypes
                            if (subtypes.length === 0) {
                                Swal.fire({
                                    icon: 'warning',
                                    title: 'No Subtypes',
                                    text: 'Please add at least one subtype before inserting.',
                                    confirmButtonText: 'OK'
                                });
                                return; // Stop if no valid subtype
                            }
                            const subtypesString = subtypes.join(','); // Join subtypes as comma-delimited string
                            $.ajax({
                                url: '/insert-category',  // Your server endpoint to handle the insert
                                type: 'POST',
                                contentType: 'application/json',
                                data: JSON.stringify({
                                    category_name: categoryName,
                                    safetyRisk: parseInt(safetyRisk), // Ensure it's sent as an integer
                                    impactArea: parseInt(impactArea), // Ensure it's sent as an integer
                                    reportFrequency: parseInt(reportFrequency),
                                    sub_types: subtypesString,
                                }),
                                success: function (response) {

                                    $('#insertModal').modal('hide');
                                    Swal.fire({
                                        icon: 'success',
                                        title: 'Category Inserted',
                                        text: 'The category has been added successfully.',
                                        confirmButtonText: 'OK'
                                    }).then(() => {
                                        location.reload(); // or update the row dynamically
                                    });

                                },
                                error: function () {
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Error',
                                        text: 'An error occurred during insertion.',
                                        confirmButtonText: 'Close'
                                    });
                                }
                            });
                        });
                    });
                </script>



        </body>

        </html>